#!/usr/bin/env bash
export REC_HOSTNAME="${REC_HOSTNAME:-$(hostname)}"

if [[ "x${TMUX}" == "x" ]]; then
  # TODO fix case where exit 0 but no sessions
  tmux ls 1>/dev/null 2>&1
  exit_code=$?

  if [[ ! -d "$HOME/asciinema/" ]]; then
    mkdir -p "$HOME/asciinema/"
  fi

  outfile="$HOME/asciinema/rec-$(hostname)-$(date +%4Y-%m-%d-%H-%M-%ss).ndjson"
  # >(xz --stdout - > "$HOME/asciinema/rec-$(hostname)-$(date +%4Y-%m-%d-%H-%M-%ss).ndjson.xz")
  if [[ "x${exit_code}" == "x0" ]]; then
    $PYTHON -m asciinema rec --idle-time-limit 0.5 --title "$(date +%4Y-%m-%d-%H-%M-%ss)" --command "tmux a" > "${outfile}"
  else
    $PYTHON -m asciinema rec --idle-time-limit 0.5 --title "$(date +%4Y-%m-%d-%H-%M-%ss)" --command "tmux" > "${outfile}"
  fi
fi
